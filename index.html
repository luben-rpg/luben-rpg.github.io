<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador IA Avanzado - Lógica Proposicional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #3498db;
            --ai-bubble: #e3f2fd;
            --user-bubble: #f0f4f8;
            --learning: #9b59b6;
            --reading: #16a085;
            --formula: #8e44ad;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            grid-template-areas: 
                "header header"
                "problem assistant"
                "footer footer";
        }
        
        header {
            grid-area: header;
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
        }
        
        .learning-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--learning);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .problem-section {
            grid-area: problem;
            padding: 20px;
            background: var(--light);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .assistant-section {
            grid-area: assistant;
            padding: 20px;
            background: white;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #eee;
            position: relative;
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary);
        }
        
        .exercise {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .exercise-content {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid var(--secondary);
        }
        
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            border-color: var(--secondary);
            outline: none;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: var(--success);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #27ae60;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: var(--accent);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-learning {
            background: var(--learning);
            color: white;
        }
        
        .btn-learning:hover {
            background: #8e44ad;
        }
        
        .btn-reading {
            background: var(--reading);
            color: white;
        }
        
        .btn-reading:hover {
            background: #1abc9c;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        
        .upload-area:hover {
            border-color: var(--secondary);
            background-color: #f8f9fa;
        }
        
        .upload-area.drag-over {
            border-color: var(--secondary);
            background-color: #e3f2fd;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #7f8c8d;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 15px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            max-height: 400px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.4;
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .ai-message {
            align-self: flex-start;
            background: var(--ai-bubble);
            border-bottom-left-radius: 4px;
        }
        
        .user-message {
            align-self: flex-end;
            background: var(--user-bubble);
            border-bottom-right-radius: 4px;
        }
        
        .message-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .message-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 20px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .message-input input:focus {
            border-color: var(--secondary);
        }
        
        .send-btn {
            background: var(--secondary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .send-btn:hover {
            background: #2980b9;
        }
        
        .solution-step {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .step-title {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .correct {
            border-left: 4px solid var(--success);
        }
        
        .incorrect {
            border-left: 4px solid var(--accent);
        }
        
        .feedback {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            background: #ffeaa7;
            border-left: 4px solid var(--warning);
        }
        
        .truth-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .truth-table th, .truth-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .truth-table th {
            background: var(--primary);
            color: white;
        }
        
        .truth-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .circuit-diagram {
            font-family: monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            white-space: pre;
            overflow-x: auto;
        }
        
        footer {
            grid-area: footer;
            text-align: center;
            padding: 20px;
            background: var(--dark);
            color: white;
        }
        
        .analysis-progress {
            height: 5px;
            width: 100%;
            background: #eee;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--secondary);
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        
        .exercise-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .exercise-type-btn {
            padding: 8px 15px;
            background: #e0e0e0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .exercise-type-btn.active {
            background: var(--secondary);
            color: white;
        }
        
        .hint-box {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid var(--info);
        }
        
        .feedback-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        
        .feedback-btn {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .feedback-btn:hover {
            background: #e0e0e0;
        }
        
        .feedback-btn.helpful {
            color: var(--success);
        }
        
        .feedback-btn.not-helpful {
            color: var(--accent);
        }
        
        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .suggestion-chip {
            padding: 8px 15px;
            background: #e3f2fd;
            border-radius: 18px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .suggestion-chip:hover {
            background: #d0e5fc;
        }
        
        .user-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .progress-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .progress-tracker {
            flex: 1;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-value {
            height: 100%;
            background: var(--success);
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "header"
                    "problem"
                    "assistant"
                    "footer";
            }
            
            .assistant-section {
                border-left: none;
                border-top: 1px solid #eee;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
        
        .typing-indicator {
            display: flex;
            padding: 10px;
            background: var(--ai-bubble);
            border-radius: 18px;
            align-self: flex-start;
            margin-bottom: 10px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #888;
            border-radius: 50%;
            margin: 0 3px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .learning-notice {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--learning);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
        }
        
        .learning-notice.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Estilos para el módulo de lectura */
        .reading-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .reading-content {
            background: white;
            width: 90%;
            max-width: 1000px;
            height: 80%;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }
        
        .reading-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-reading {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .reading-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .book-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #eee;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .book-content h3 {
            color: var(--primary);
            margin: 20px 0 10px;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 5px;
        }
        
        .book-content p {
            margin-bottom: 15px;
            text-align: justify;
        }
        
        .book-content .important {
            background: #fff9e6;
            padding: 10px 15px;
            border-left: 4px solid var(--warning);
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .book-content .definition {
            background: #e8f4fd;
            padding: 10px 15px;
            border-left: 4px solid var(--info);
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .book-content .example {
            background: #f0f9f0;
            padding: 10px 15px;
            border-left: 4px solid var(--success);
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .ia-assistance {
            width: 300px;
            padding: 15px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .ia-explanation {
            background: var(--ai-bubble);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        
        .ia-suggestions {
            margin-top: 15px;
        }
        
        .suggestion-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid var(--reading);
        }
        
        .suggestion-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }
        
        .chapter-nav {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            background: #f5f5f5;
            border-top: 1px solid #eee;
        }
        
        .nav-btn {
            padding: 8px 15px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .bookmark-btn {
            background: var(--reading);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .reading-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .control-btn {
            padding: 8px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .control-btn.active {
            background: var(--secondary);
            color: white;
        }
        
        /* Nuevos estilos para el área de fórmulas */
        .formula-input-container {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--formula);
        }
        
        .formula-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .formula-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
        }
        
        .formula-input input:focus {
            border-color: var(--formula);
            outline: none;
        }
        
        .formula-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .formula-btn {
            padding: 8px 12px;
            background: #e0e0e0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }
        
        .formula-btn:hover {
            background: #d0d0d0;
        }
        
        .formula-examples {
            margin-top: 15px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .formula-examples h4 {
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .example-chip {
            display: inline-block;
            padding: 5px 10px;
            margin: 0 5px 5px 0;
            background: white;
            border-radius: 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .example-chip:hover {
            background: #d0e5fc;
        }
        
        .formula-result {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .simplified-formula {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            padding: 10px;
            background: #f0f9f0;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid var(--success);
        }
        
        .evaluation-steps {
            margin-top: 15px;
        }
        
        .step {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }
        
        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .evaluation-table th, .evaluation-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .evaluation-table th {
            background: var(--primary);
            color: white;
        }
        
        .symbol-guide {
            margin-top: 15px;
            padding: 10px;
            background: #fff9e6;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .symbol-item {
            display: inline-block;
            margin-right: 15px;
        }
        
        .symbol {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: var(--formula);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="learning-badge">
                <i class="fas fa-brain"></i> IA con Aprendizaje
            </div>
            <h1><i class="fas fa-robot"></i> Analizador IA Avanzado - Lógica Proposicional</h1>
            <p class="subtitle">IA mejorada que resuelve ejercicios propuestos paso a paso</p>
            <button class="btn-reading" onclick="openReadingModal()">
                <i class="fas fa-book"></i> Leer Libro con Asistencia IA
            </button>
        </header>
        
        <div class="problem-section">
            <h2><i class="fas fa-pencil-alt"></i> Ejercicio Actual</h2>
            
            <div class="exercise-selector">
                <button class="exercise-type-btn active" onclick="changeExerciseType('basic')">Básico</button>
                <button class="exercise-type-btn" onclick="changeExerciseType('truth-table')">Tablas de Verdad</button>
                <button class="exercise-type-btn" onclick="changeExerciseType('circuit')">Circuitos Lógicos</button>
                <button class="exercise-type-btn" onclick="changeExerciseType('formula')">Resolver Fórmula</button>
            </div>
            
            <div class="exercise">
                <h3>Problema #1 <span class="exercise-difficulty">(Básico)</span></h3>
                <div class="exercise-content">
                    Dadas las proposiciones:
                    p: "5 es un número primo"
                    q: "4 < 2"
                    
                    Determine el valor de verdad de:
                    p ∧ q, p ∨ q, p → q
                </div>
                
                <div class="hint-box">
                    <strong><i class="fas fa-lightbulb"></i> Sugerencia:</strong> Recuerda que una conjunción (∧) es verdadera solo cuando ambas proposiciones son verdaderas.
                </div>
            </div>
            
            <!-- Nuevo contenedor para entrada de fórmulas (inicialmente oculto) -->
            <div id="formula-input-container" style="display: none;">
                <h3><i class="fas fa-square-root-alt"></i> Resolver Fórmula Lógica</h3>
                
                <div class="formula-input">
                    <input type="text" id="formulaInput" placeholder="Ingresa la fórmula lógica (ej: p ∧ q, ¬p ∨ q, p → q)">
                    <button class="btn-primary" onclick="analyzeFormula()">
                        <i class="fas fa-calculator"></i> Analizar
                    </button>
                </div>
                
                <div class="formula-buttons">
                    <button class="formula-btn" onclick="insertSymbol('¬')">¬ (NO)</button>
                    <button class="formula-btn" onclick="insertSymbol('∧')">∧ (Y)</button>
                    <button class="formula-btn" onclick="insertSymbol('∨')">∨ (O)</button>
                    <button class="formula-btn" onclick="insertSymbol('→')">→ (ENTONCES)</button>
                    <button class="formula-btn" onclick="insertSymbol('↔')">↔ (SI Y SOLO SI)</button>
                    <button class="formula-btn" onclick="insertSymbol('(')">(</button>
                    <button class="formula-btn" onclick="insertSymbol(')')">)</button>
                </div>
                
                <div class="symbol-guide">
                    <strong>Guía de símbolos:</strong>
                    <div class="symbol-item"><span class="symbol">¬</span> Negación</div>
                    <div class="symbol-item"><span class="symbol">∧</span> Conjunción (Y)</div>
                    <div class="symbol-item"><span class="symbol">∨</span> Disyunción (O)</div>
                    <div class="symbol-item"><span class="symbol">→</span> Condicional (Entonces)</div>
                    <div class="symbol-item"><span class="symbol">↔</span> Bicondicional (Si y solo si)</div>
                </div>
                
                <div class="formula-examples">
                    <h4>Ejemplos para probar:</h4>
                    <div class="example-chip" onclick="setFormulaExample('p ∧ q')">p ∧ q</div>
                    <div class="example-chip" onclick="setFormulaExample('¬p ∨ q')">¬p ∨ q</div>
                    <div class="example-chip" onclick="setFormulaExample('p → q')">p → q</div>
                    <div class="example-chip" onclick="setFormulaExample('(p ∨ q) ∧ ¬p')">(p ∨ q) ∧ ¬p</div>
                    <div class="example-chip" onclick="setFormulaExample('p ↔ (q ∨ r)')">p ↔ (q ∨ r)</div>
                </div>
                
                <div id="formulaResult" class="formula-result" style="display: none;">
                    <!-- Aquí se mostrarán los resultados del análisis -->
                </div>
            </div>
            
            <div class="input-area">
                <h3><i class="fas fa-edit"></i> Tu respuesta:</h3>
                <textarea id="userSolution" placeholder="Escribe tu solución paso a paso aquí..."></textarea>
                
                <div class="buttons">
                    <button class="btn-primary" onclick="checkSolution()">
                        <i class="fas fa-check-circle"></i> Verificar solución
                    </button>
                    <button class="btn-secondary" onclick="showSolution()">
                        <i class="fas fa-eye"></i> Mostrar solución
                    </button>
                    <button class="btn-warning" onclick="newExercise()">
                        <i class="fas fa-plus-circle"></i> Nuevo ejercicio
                    </button>
                    <button class="btn-learning" onclick="adaptiveExplanation()">
                        <i class="fas fa-graduation-cap"></i> Explicación Adaptativa
                    </button>
                    <button class="btn-danger" onclick="clearAll()">
                        <i class="fas fa-trash"></i> Limpiar
                    </button>
                </div>
            </div>
            
            <div class="user-progress">
                <span class="progress-label">Tu progreso:</span>
                <div class="progress-tracker">
                    <div class="progress-value" id="progressValue" style="width: 0%"></div>
                </div>
                <span id="progressPercent">0%</span>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this.files)">
                <div class="upload-icon">
                    <i class="fas fa-camera"></i>
                </div>
                <p>Haz clic o arrastra una imagen de un ejercicio para analizarlo</p>
                <img id="imagePreview" class="image-preview" alt="Vista previa de la imagen">
                <div class="analysis-progress" id="progressBar">
                    <div class="progress-bar" id="progressFill"></div>
                </div>
            </div>
            
            <div class="feedback" id="feedbackSection">
                <h3><i class="fas fa-comment-dots"></i> Retroalimentación</h3>
                <p>Aquí verás el análisis de tu respuesta y correcciones si es necesario.</p>
            </div>
        </div>
        
        <div class="assistant-section">
            <div class="learning-notice" id="learningNotice">
                <i class="fas fa-sync-alt"></i> Aprendiendo de tu interacción...
            </div>
            
            <h2><i class="fas fa-robot"></i> Asistente IA Avanzado</h2>
            
            <div class="chat-container" id="chatContainer">
                <div class="message ai-message">
                    ¡Hola! Soy tu asistente avanzado de lógica proposicional. Ahora puedo resolver fórmulas lógicas que me proporciones. Escribe una fórmula o sube una imagen con un ejercicio.
                </div>
                <div class="message ai-message">
                    Puedes usar los símbolos: ¬ (negación), ∧ (conjunción), ∨ (disyunción), → (condicional), ↔ (bicondicional)
                    <div class="suggestion-chips">
                        <div class="suggestion-chip" onclick="sendSuggestion('¿Cómo analizar p ∧ q?')">¿Cómo analizar p ∧ q?</div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Explícame las tablas de verdad')">Explícame las tablas de verdad</div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Necesito un ejemplo de circuito')">Necesito un ejemplo de circuito</div>
                    </div>
                </div>
            </div>
            
            <div class="message-input">
                <input type="text" id="userInput" placeholder="Escribe tu pregunta aquí..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <footer>
            <p>Analizador IA Avanzado de Lógica Proposicional - Basado en "Fundamentos de la Matemática" de Jorge Sáenz</p>
        </footer>
    </div>

    <!-- Modal de lectura del libro -->
    <div class="reading-modal" id="readingModal">
        <div class="reading-content">
            <div class="reading-header">
                <h2><i class="fas fa-book"></i> Fundamentos de la Matemática - Jorge Sáenz</h2>
                <button class="close-reading" onclick="closeReadingModal()">&times;</button>
            </div>
            <div class="reading-body">
                <div class="book-content" id="bookContent">
                    <!-- El contenido del libro se cargará aquí -->
                </div>
                <div class="ia-assistance">
                    <h3><i class="fas fa-robot"></i> Asistente de Lectura</h3>
                    <div class="ia-explanation" id="iaExplanation">
                        Selecciona un capítulo o tema para obtener explicaciones y sugerencias de estudio.
                    </div>
                    
                    <div class="reading-controls">
                        <button class="control-btn" onclick="changeExplanationLevel('basic')" id="btnBasic">Básico</button>
                        <button class="control-btn active" onclick="changeExplanationLevel('normal')" id="btnNormal">Normal</button>
                        <button class="control-btn" onclick="changeExplanationLevel('advanced')" id="btnAdvanced">Avanzado</button>
                    </div>
                    
                    <div class="ia-suggestions">
                        <h4>Sugerencias de estudio:</h4>
                        <div class="suggestion-item" onclick="askQuestion('explicame este concepto')">
                            <i class="fas fa-question-circle"></i> Explicar este concepto
                        </div>
                        <div class="suggestion-item" onclick="askQuestion('ejemplo de este tema')">
                            <i class="fas fa-lightbulb"></i> Mostrar un ejemplo
                        </div>
                        <div class="suggestion-item" onclick="askQuestion('ejercicio relacionado')">
                            <i class="fas fa-pencil-alt"></i> Proponer un ejercicio
                        </div>
                        <div class="suggestion-item" onclick="askQuestion('aplicación práctica')">
                            <i class="fas fa-rocket"></i> Aplicación práctica
                        </div>
                    </div>
                </div>
            </div>
            <div class="chapter-nav">
                <button class="nav-btn" id="prevChapter" onclick="changeChapter(-1)" disabled>
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <span id="currentChapter">Capítulo 1: Lógica Proposicional</span>
                <button class="nav-btn" id="nextChapter" onclick="changeChapter(1)">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Ejercicios predefinidos por tipo
        const exercises = {
            basic: [
                {
                    id: 1,
                    content: `Dadas las proposiciones:
p: "5 es un número primo"
q: "4 < 2"
                        
Determine el valor de verdad de:
p ∧ q, p ∨ q, p → q`,
                    solution: {
                        steps: [
                            "p: '5 es un número primo' → Verdadero (1)",
                            "q: '4 < 2' → Falso (0)",
                            "p ∧ q = 1 ∧ 0 = 0 (Falso)",
                            "p ∨ q = 1 ∨ 0 = 1 (Verdadero)",
                            "p → q = 1 → 0 = 0 (Falso)"
                        ]
                    }
                },
                {
                    id: 2,
                    content: `Dadas las proposiciones:
p: "π es un número racional"
q: "√4 = 2"
                        
Determine el valor de verdad de:
p ∨ q, p ∧ q, ¬p`,
                    solution: {
                        steps: [
                            "p: 'π es un número racional' → Falso (0)",
                            "q: '√4 = 2' → Verdadero (1)",
                            "p ∨ q = 0 ∨ 1 = 1 (Verdadero)",
                            "p ∧ q = 0 ∧ 1 = 0 (Falso)",
                            "¬p = ¬0 = 1 (Verdadero)"
                        ]
                    }
                }
            ],
            "truth-table": [
                {
                    id: 1,
                    content: `Construya la tabla de verdad para la proposición:
(p ∨ q) ∧ ¬p`,
                    solution: {
                        steps: [
                            "Primero identificamos las variables: p, q",
                            "Construimos las columnas para p, q, p ∨ q, ¬p, y (p ∨ q) ∧ ¬p",
                            "Completamos todas las combinaciones posibles de valores de verdad",
                            "Evaluamos p ∨ q para cada combinación",
                            "Evaluamos ¬p para cada combinación",
                            "Finalmente evaluamos (p ∨ q) ∧ ¬p"
                        ]
                    }
                },
                {
                    id: 2,
                    content: `Construya la tabla de verdad para la proposición:
(p → q) ∧ (q → p)`,
                    solution: {
                        steps: [
                            "Esta expresión es equivalente a p ↔ q (bicondicional)",
                            "La bicondicional es verdadera cuando p y q tienen el mismo valor de verdad",
                            "Construimos la tabla con todas las combinaciones de p y q",
                            "Evaluamos p → q para cada combinación",
                            "Evaluamos q → p para cada combinación",
                            "Finalmente evaluamos la conjunción de ambos condicionales"
                        ]
                    }
                }
            ],
            circuit: [
                {
                    id: 1,
                    content: `Diseñe el circuito lógico para la expresión:
(p ∧ q) ∨ (¬p ∧ r)`,
                    solution: {
                        steps: [
                            "Identificamos las compuertas necesarias: AND, OR y NOT",
                            "Diseñamos la parte (p ∧ q) con una compuerta AND",
                            "Diseñamos la parte (¬p ∧ r) con un NOT seguido de una AND",
                            "Combinamos ambas partes con una compuerta OR",
                            "Dibujamos el diagrama completo del circuito"
                        ]
                    }
                },
                {
                    id: 2,
                    content: `Diseñe el circuito lógico para la expresión:
¬(p ∨ q) ∧ r`,
                    solution: {
                        steps: [
                            "Identificamos las compuertas necesarias: OR, NOT y AND",
                            "Primero diseñamos (p ∨ q) con una compuerta OR",
                            "Aplicamos la negación ¬(p ∨ q) con una compuerta NOT",
                            "Finalmente combinamos con r usando una compuerta AND",
                            "Dibujamos el diagrama completo del circuito"
                        ]
                    }
                }
            ]
        };

        // Contenido del libro "Fundamentos de la Matemática" de Jorge Sáenz
        const bookContent = {
            chapter1: {
                title: "Capítulo 1: Lógica Proposicional",
                content: `
                    <h3>1.1 Proposiciones</h3>
                    <p>Una <strong>proposición</strong> es una expresión lingüística que puede ser calificada como verdadera o falsa, pero no ambas cosas a la vez.</p>
                    
                    <div class="definition">
                        <strong>Definición:</strong> Una proposición es un enunciado que tiene un valor de verdad bien definido, es decir, que es verdadero (V) o falso (F), pero no ambos.
                    </div>
                    
                    <div class="example">
                        <strong>Ejemplos de proposiciones:</strong>
                        <ul>
                            <li>"5 es un número primo" → Verdadera</li>
                            <li>"4 es mayor que 10" → Falsa</li>
                            <li>"Quito es la capital de Ecuador" → Verdadera</li>
                        </ul>
                    </div>
                    
                    <div class="important">
                        <strong>Importante:</strong> No son proposiciones:
                        <ul>
                            <li>Preguntas: "¿Qué hora es?"</li>
                            <li>Órdenes: "Abre la ventana"</li>
                            <li>Exclamaciones: "¡Qué sorpresa!"</li>
                            <li>Enunciados vagos: "Él es alto" (depende de contexto)</li>
                        </ul>
                    </div>
                    
                    <h3>1.2 Conectivos Lógicos</h3>
                    <p>Los conectivos lógicos son operadores que permiten formar proposiciones compuestas a partir de proposiciones simples.</p>
                    
                    <p><strong>Conjunción (∧):</strong> Representa "y". La proposición p ∧ q es verdadera solo cuando ambas proposiciones son verdaderas.</p>
                    
                    <p><strong>Disyunción (∨):</strong> Representa "o". La proposición p ∨ q es falsa solo cuando ambas proposiciones son falsas.</p>
                    
                    <p><strong>Condicional (→):</strong> Representa "si... entonces...". La proposición p → q es falsa solo cuando p es verdadera y q es falsa.</p>
                    
                    <p><strong>Bicondicional (↔):</strong> Representa "si y solo si". La proposición p ↔ q es verdadera cuando ambas proposiciones tienen el mismo valor de verdad.</p>
                    
                    <p><strong>Negación (¬):</strong> Invierte el valor de verdad de la proposición.</p>
                    
                    <h3>1.3 Tablas de Verdad</h3>
                    <p>Una tabla de verdad es una representación sistemática de todos los posibles valores de verdad de una proposición compuesta.</p>
                    
                    <div class="example">
                        <strong>Ejemplo: Tabla de verdad para p ∧ q</strong>
                        <table class="truth-table">
                            <tr>
                                <th>p</th>
                                <th>q</th>
                                <th>p ∧ q</th>
                            </tr>
                            <tr>
                                <td>V</td>
                                <td>V</td>
                                <td>V</td>
                            </tr>
                            <tr>
                                <td>V</td>
                                <td>F</td>
                                <td>F</td>
                            </tr>
                            <tr>
                                <td>F</td>
                                <td>V</td>
                                <td>F</td>
                            </tr>
                            <tr>
                                <td>F</td>
                                <td>F</td>
                                <td>F</td>
                            </tr>
                        </table>
                    </div>
                `
            },
            chapter2: {
                title: "Capítulo 2: Circuitos Lógicos",
                content: `
                    <h3>2.1 Compuertas Lógicas</h3>
                    <p>Las compuertas lógicas son dispositivos electrónicos que implementan las operaciones lógicas básicas.</p>
                    
                    <div class="definition">
                        <strong>Compuerta AND:</strong> Implementa la conjunción lógica. Su salida es 1 solo cuando todas sus entradas son 1.
                    </div>
                    
                    <div class="definition">
                        <strong>Compuerta OR:</strong> Implementa la disyunción lógica. Su salida es 1 cuando al menos una de sus entradas es 1.
                    </div>
                    
                    <div class="definition">
                        <strong>Compuerta NOT:</strong> Implementa la negación lógica. Su salida es el valor contrario a su entrada.
                    </div>
                    
                    <h3>2.2 Diseño de Circuitos</h3>
                    <p>Los circuitos lógicos se diseñan combinando compuertas lógicas para implementar funciones booleanas.</p>
                    
                    <div class="example">
                        <strong>Ejemplo: Circuito para p ∧ q</strong>
                        <p>Este circuito requiere una sola compuerta AND con dos entradas (p y q).</p>
                    </div>
                    
                    <div class="example">
                        <strong>Ejemplo: Circuito para (p ∨ q) ∧ ¬r</strong>
                        <p>Este circuito requiere:
                        <ul>
                            <li>Una compuerta OR para (p ∨ q)</li>
                            <li>Una compuerta NOT para ¬r</li>
                            <li>Una compuerta AND para combinar los resultados</li>
                        </ul>
                        </p>
                    </div>
                    
                    <div class="important">
                        <strong>Importante:</strong> Los circuitos lógicos son la base de los sistemas digitales y se utilizan en computadoras, teléfonos y todo tipo de dispositivos electrónicos.
                    </div>
                `
            },
            chapter3: {
                title: "Capítulo 3: Métodos de Demostración",
                content: `
                    <h3>3.1 Demostración Directa</h3>
                    <p>En una demostración directa, partimos de las premisas y mediante inferencias lógicas llegamos a la conclusión.</p>
                    
                    <div class="example">
                        <strong>Ejemplo:</strong> Demostrar que "Si n es par, entonces n² es par".
                        <p>Solución: Si n es par, entonces n = 2k para algún entero k. Entonces n² = (2k)² = 4k² = 2(2k²), que es par.</p>
                    </div>
                    
                    <h3>3.2 Demostración por Contradicción</h3>
                    <p>En una demostración por contradicción, suponemos que la conclusión es falsa y llegamos a una contradicción.</p>
                    
                    <div class="example">
                        <strong>Ejemplo:</strong> Demostrar que "√2 es irracional".
                        <p>Solución: Supongamos que √2 es racional. Entonces √2 = a/b donde a and b son enteros coprimos. Elevando al cuadrado: 2 = a²/b², entonces a² = 2b². Esto implica que a² es par, por lo que a es par. Sea a = 2c. Entonces (2c)² = 2b², por lo que 4c² = 2b², entonces b² = 2c², por lo que b² es par y b es par. Pero si a y b son pares, entonces no son coprimos, lo que contradice nuestra suposición. Por lo tanto, √2 es irracional.</p>
                    </div>
                    
                    <h3>3.3 Demostración por Inducción</h3>
                    <p>La inducción matemática se utiliza para demostrar proposiciones que dependen de un parámetro natural n.</p>
                    
                    <div class="important">
                        <strong>Pasos de la inducción matemática:</strong>
                        <ol>
                            <li><strong>Base inductiva:</strong> Demostrar que la proposición es verdadera para n = 1.</li>
                            <li><strong>Hipótesis inductiva:</strong> Suponer que la proposición es verdadera para n = k.</li>
                            <li><strong>Paso inductivo:</strong> Demostrar que la proposición es verdadera para n = k + 1.</li>
                        </ol>
                    </div>
                `
            }
        };

        // Sistema de aprendizaje de la IA
        const aiLearningSystem = {
            userKnowledge: {
                basic: { score: 0, attempts: 0, correct: 0 },
                truthTable: { score: 0, attempts: 0, correct: 0 },
                circuit: { score: 0, attempts: 0, correct: 0 },
                formula: { score: 0, attempts: 0, correct: 0 }
            },
            explanationLevel: 1, // 1: Básico, 2: Intermedio, 3: Avanzado
            userPreferences: {
                detailedExplanations: true,
                examples: true,
                visualAids: true
            },
            conversationHistory: [],
            feedbackHistory: [],
            
            // Aprender de la retroalimentación del usuario
            learnFromFeedback: function(messageId, wasHelpful, feedbackText = "") {
                this.feedbackHistory.push({
                    messageId,
                    wasHelpful,
                    feedbackText,
                    timestamp: new Date()
                });
                
                // Ajustar el nivel de explicación según la retroalimentación
                if (wasHelpful) {
                    this.explanationLevel = Math.min(3, this.explanationLevel + 0.1);
                    showLearningNotice("¡Gracias por tu feedback! Estoy mejorando mis explicaciones.");
                } else {
                    this.explanationLevel = Math.max(1, this.explanationLevel - 0.2);
                    showLearningNotice("Ajustando mis explicaciones basado en tu feedback...");
                    
                    // Si hay texto de retroalimentación, aprender de él
                    if (feedbackText) {
                        this.learnFromTextFeedback(feedbackText);
                    }
                }
                
                // Guardar en localStorage
                this.saveToLocalStorage();
            },
            
            // Aprender del texto de retroalimentación
            learnFromTextFeedback: function(feedbackText) {
                const lowerFeedback = feedbackText.toLowerCase();
                
                // Detectar solicitudes de más detalle
                if (lowerFeedback.includes("más detalle") || lowerFeedback.includes("explica mejor") || 
                    lowerFeedback.includes("no entiendo")) {
                    this.userPreferences.detailedExplanations = true;
                }
                
                // Detectar solicitudes de ejemplos
                if (lowerFeedback.includes("ejemplo") || lowerFeedback.includes("ejempl")) {
                    this.userPreferences.examples = true;
                }
                
                // Detectar solicitudes de ayudas visuales
                if (lowerFeedback.includes("visual") || lowerFeedback.includes("gráfico") || 
                    lowerFeedback.includes("diagrama")) {
                    this.userPreferences.visualAids = true;
                }
            },
            
            // Aprender del historial de conversación
            learnFromConversation: function() {
                // Analizar el historial de conversación para mejorar
                const lastFiveMessages = this.conversationHistory.slice(-5);
                
                // Contar preguntas del usuario
                const userQuestions = lastFiveMessages.filter(msg => msg.sender === 'user').length;
                
                // Si el usuario hace muchas preguntas, puede necesitar explicaciones más detalladas
                if (userQuestions >= 3) {
                    this.userPreferences.detailedExplanations = true;
                    this.explanationLevel = Math.min(3, this.explanationLevel + 0.2);
                }
                
                // Guardar en localStorage
                this.saveToLocalStorage();
            },
            
            // Actualizar el conocimiento del usuario
            updateUserKnowledge: function(topic, isCorrect) {
                if (!this.userKnowledge[topic]) {
                    this.userKnowledge[topic] = { score: 0, attempts: 0, correct: 0 };
                }
                
                this.userKnowledge[topic].attempts++;
                if (isCorrect) {
                    this.userKnowledge[topic].correct++;
                }
                
                this.userKnowledge[topic].score = this.userKnowledge[topic].correct / this.userKnowledge[topic].attempts;
                
                // Actualizar barra de progreso
                updateProgressBar();
                
                // Guardar en localStorage
                this.saveToLocalStorage();
            },
            
            // Obtener explicación adaptada al usuario
            getAdaptedExplanation: function(topic, baseExplanation) {
                let explanation = baseExplanation;
                
                // Añadir más detalle si es necesario
                if (this.userPreferences.detailedExplanations) {
                    explanation += this.getAdditionalDetails(topic);
                }
                
                // Añadir ejemplos si es necesario
                if (this.userPreferences.examples) {
                    explanation += this.getExample(topic);
                }
                
                // Ajustar según el nivel de explicación
                if (this.explanationLevel < 2) {
                    // Explicación más simple
                    explanation = explanation.replace(/términos técnicos/g, "conceptos")
                                             .replace(/En lógica proposicional/g, "En este tema");
                } else if (this.explanationLevel > 2) {
                    // Explicación más avanzada
                    explanation += this.getAdvancedInsight(topic);
                }
                
                return explanation;
            },
            
            // Obtener detalles adicionales según el tema
            getAdditionalDetails: function(topic) {
                const details = {
                    basic: "\n\nRecuerda que en lógica proposicional trabajamos con valores de verdad binarios: verdadero (1) y falso (0).",
                    truthTable: "\n\nCada variable proposicional tiene dos valores posibles, por lo que para n variables necesitarás 2^n filas en tu tabla de verdad.",
                    circuit: "\n\nLas compuertas lógicas se pueden combinar de muchas formas para crear circuitos más complejos que representen expresiones lógicas.",
                    formula: "\n\nAl analizar fórmulas complejas, es útil descomponerlas en partes más pequeñas y evaluar cada componente por separado."
                };
                
                return details[topic] || "";
            },
            
            // Obtener ejemplos según el tema
            getExample: function(topic) {
                const examples = {
                    basic: "\n\nPor ejemplo, si p es verdadero y q es falso, entonces p ∧ q es falso, pero p ∨ q es verdadero.",
                    truthTable: "\n\nPor ejemplo, para una expresión con 2 variables, la tabla de verdad tendrá 4 filas que representan todas las combinaciones posibles.",
                    circuit: "\n\nPor ejemplo, la expresión p ∧ q se representaría con una compuerta AND que toma las entradas p y q.",
                    formula: "\n\nPor ejemplo, la fórmula ¬(p ∨ q) es equivalente a ¬p ∧ ¬q según las leyes de De Morgan."
                };
                
                return examples[topic] || "";
            },
            
            // Obtener información avanzada según el tema
            getAdvancedInsight: function(topic) {
                const insights = {
                    basic: "\n\nDesde una perspectiva más avanzada, puedes notar que el operador condicional (→) no es conmutativo, a diferencia de la conjunción y disyunción.",
                    truthTable: "\n\nUna perspectiva avanzada: las tablas de verdad son la base para la implementación de circuitos digitales y álgebra booleana.",
                    circuit: "\n\nPerspectiva avanzada: estos circuitos lógicos son la base de los procesadores modernos y se implementan físicamente con transistores.",
                    formula: "\n\nPerspectiva avanzada: el análisis de fórmulas lógicas es fundamental en ciencias de la computación, especialmente en verificación formal y diseño de algoritmos."
                };
                
                return insights[topic] || "";
            },
            
            // Guardar en localStorage
            saveToLocalStorage: function() {
                const data = {
                    userKnowledge: this.userKnowledge,
                    explanationLevel: this.explanationLevel,
                    userPreferences: this.userPreferences,
                    feedbackHistory: this.feedbackHistory
                };
                
                localStorage.setItem('aiLearningData', JSON.stringify(data));
            },
            
            // Cargar desde localStorage
            loadFromLocalStorage: function() {
                const data = JSON.parse(localStorage.getItem('aiLearningData'));
                if (data) {
                    this.userKnowledge = data.userKnowledge || this.userKnowledge;
                    this.explanationLevel = data.explanationLevel || this.explanationLevel;
                    this.userPreferences = data.userPreferences || this.userPreferences;
                    this.feedbackHistory = data.feedbackHistory || this.feedbackHistory;
                    
                    // Actualizar barra de progreso
                    updateProgressBar();
                }
            }
        };

        let currentExerciseType = 'basic';
        let currentExerciseIndex = 0;
        let messageCounter = 0;
        
        // Variables para el módulo de lectura
        let currentChapter = 1;
        let explanationLevel = 'normal';

        // Respuestas predefinidas del asistente IA mejorado
        const aiResponses = {
            "hola": "¡Hola! Soy tu asistente avanzado de lógica proposicional. Puedo analizar tus respuestas escritas, explicarte conceptos y ayudarte a resolver problemas. ¿En qué necesitas ayuda?",
            "ayuda": "Puedo ayudarte con: valores de verdad, tablas de verdad, circuitos lógicos, equivalencias lógicas y más. También puedo analizar tus respuestas escritas y proporcionarte retroalimentación detallada.",
            "verdad": "El valor de verdad de una proposición es su cualidad de ser verdadera (1) o falsa (0). En lógica proposicional, trabajamos con estos dos valores.",
            "conjuncion": "La conjunción (p ∧ q) es verdadera solo cuando ambas proposiciones son verdaderas. Su tabla de verdad es: p=1, q=1 → 1; p=1, q=0 → 0; p=0, q=1 → 0; p=0, q=0 → 0.",
            "disyuncion": "La disyunción (p ∨ q) es falsa solo cuando ambas proposiciones son falsas. Su tabla de verdad es: p=1, q=1 → 1; p=1, q=0 → 1; p=0, q=1 → 1; p=0, q=0 → 0.",
            "condicional": "El condicional (p → q) es falso solo cuando p es verdadera y q es falsa. Su tabla de verdad es: p=1, q=1 → 1; p=1, q=0 → 0; p=0, q=1 → 1; p=0, q=0 → 1.",
            "tabla": "Una tabla de verdad muestra todos los posibles valores de verdad de una proposición compuesta. Para n variables, hay 2^n combinaciones posibles.",
            "circuito": "Los circuitos lógicos representan proposiciones usando compuertas AND, OR y NOT. Cada compuerta corresponde a un operador lógico específico.",
            "formula": "Puedo analizar fórmulas lógicas que me proporciones. Usa los símbolos: ¬ (negación), ∧ (conjunción), ∨ (disyunción), → (condicional), ↔ (bicondicional).",
            "default": "No estoy seguro de entender completamente. ¿Podrías reformular tu pregunta o ser más específico? Estoy aquí para ayudarte con conceptos de lógica proposicional."
        };

        // Funciones para el módulo de lectura
        function openReadingModal() {
            document.getElementById('readingModal').style.display = 'flex';
            loadChapter(currentChapter);
        }

        function closeReadingModal() {
            document.getElementById('readingModal').style.display = 'none';
        }

        function loadChapter(chapterNumber) {
            const chapterKey = `chapter${chapterNumber}`;
            if (bookContent[chapterKey]) {
                document.getElementById('bookContent').innerHTML = bookContent[chapterKey].content;
                document.getElementById('currentChapter').textContent = bookContent[chapterKey].title;
                
                // Actualizar botones de navegación
                document.getElementById('prevChapter').disabled = chapterNumber === 1;
                document.getElementById('nextChapter').disabled = chapterNumber === 3;
                
                // Mostrar explicación inicial
                updateExplanation();
            }
        }

        function changeChapter(direction) {
            currentChapter += direction;
            loadChapter(currentChapter);
        }

        function changeExplanationLevel(level) {
            explanationLevel = level;
            
            // Actualizar botones
            document.getElementById('btnBasic').classList.toggle('active', level === 'basic');
            document.getElementById('btnNormal').classList.toggle('active', level === 'normal');
            document.getElementById('btnAdvanced').classList.toggle('active', level === 'advanced');
            
            // Actualizar explicación
            updateExplanation();
        }

        function updateExplanation() {
            let explanation = "";
            
            switch(currentChapter) {
                case 1:
                    if (explanationLevel === 'basic') {
                        explanation = "En este capítulo aprenderás qué es una proposición y cómo se combinan usando conectivos lógicos. Es como aprender las palabras y reglas gramaticales básicas de un nuevo idioma.";
                    } else if (explanationLevel === 'normal') {
                        explanation = "La lógica proposicional es la base de todo razonamiento matemático. Aquí aprenderás a identificar proposiciones, entender conectivos lógicos y construir tablas de verdad. Presta especial atención a cómo funciona el condicional (→), ya que suele causar confusión.";
                    } else {
                        explanation = "Este capítulo sienta las bases para el razonamiento formal. Más allá de los conceptos básicos, reflexiona sobre cómo estos principios se aplican en programación, electrónica y matemáticas avanzadas. Las tablas de verdad son el primer paso hacia el álgebra booleana, fundamental en ciencias de la computación.";
                    }
                    break;
                case 2:
                    if (explanationLevel === 'basic') {
                        explanation = "Los circuitos lógicos son la forma práctica de aplicar la lógica proposicional. Las compuertas AND, OR y NOT son como piezas de Lego que puedes combinar para construir circuitos más complejos.";
                    } else if (explanationLevel === 'normal') {
                        explanation = "Este capítulo conecta la teoría con aplicaciones prácticas. Cada compuerta lógica corresponde directamente a un operador lógico. Al diseñar circuitos, estás implementando físicamente las expresiones lógicas que aprendiste en el capítulo anterior.";
                    } else {
                        explanation = "Los circuitos lógicos son la base de todos los sistemas digitales modernos. Profundizando, puedes explorar cómo se minimizan circuitos usando álgebra booleana, o cómo se implementan físicamente con transistores. Este conocimiento es esencial en ingeniería electrónica y arquitectura de computadoras.";
                    }
                    break;
                case 3:
                    if (explanationLevel === 'basic') {
                        explanation = "Las demostraciones matemáticas son como puzzles lógicos. Aquí aprenderás diferentes métodos para demostrar que algo es verdadero, usando lo que aprendiste sobre lógica en los capítulos anteriores.";
                    } else if (explanationLevel === 'normal') {
                        explanation = "Este capítulo te enseña a estructurar argumentos lógicos de manera rigurosa. Cada método de demostración tiene su lugar: la directa para casos simples, la contradicción para resultados de negación, y la inducción para propiedades que dependen de números naturales.";
                    } else {
                        explanation = "Las técnicas de demostración son el corazón del quehacer matemático profesional. Más allá de estos métodos básicos, existen variantes como la inducción fuerte o la demostración por casos. Dominar estas técnicas te preparará para matemáticas avanzadas y investigación.";
                    }
                    break;
            }
            
            document.getElementById('iaExplanation').textContent = explanation;
        }

        function askQuestion(type) {
            let question = "";
            let answer = "";
            
            switch(type) {
                case 'explicame este concepto':
                    if (currentChapter === 1) {
                        question = "Explicación de proposiciones y conectivos lógicos";
                        answer = "Imagina que las proposiciones son bloques de construcción y los conectivos lógicos son las formas de unirlos. Por ejemplo, la conjunción (AND) es como decir 'ambos deben ser verdaderos', mientras que la disyunción (OR) es como decir 'al menos uno debe ser verdadero'. El condicional (→) es más subtle: p → q solo es falsa cuando p es verdadera pero q es falsa. Es como una promesa: 'Si estudias, entonces aprobarás' solo se rompe si estudias pero no apruebas.";
                    } else if (currentChapter === 2) {
                        question = "Explicación de compuertas lógicas";
                        answer = "Las compuertas lógicas son como interruptores inteligentes. La compuerta AND enciende solo cuando todas sus entradas están activadas. La OR se enciende cuando al menos una entrada está activada. La NOT simplemente invierte: si la entrada es 1, la salida es 0, y viceversa. Juntas, pueden crear circuitos complejos como los que hay dentro de tu teléfono o computadora.";
                    } else {
                        question = "Explicación de métodos de demostración";
                        answer = "Cada método de demostración es una estrategia diferente para convencer de que algo es verdadero. La demostración directa es como seguir un camino paso a paso. La contradicción es como decir 'si esto fuera falso, llegaría a un absurdo'. La inducción es como una fila de fichas de dominó: si la primera cae (caso base) y cada ficha hace caer a la siguiente (paso inductivo), entonces todas caerán.";
                    }
                    break;
                case 'ejemplo de este tema':
                    if (currentChapter === 1) {
                        question = "Ejemplo de lógica proposicional";
                        answer = "Supongamos que p: 'Está lloviendo' y q: 'Tengo paraguas'. Entonces:\n- p ∧ q: 'Está lloviendo y tengo paraguas' → Solo verdadero si ambas son ciertas\n- p ∨ q: 'Está lloviendo o tengo paraguas' → Falso solo si no llueve y no tengo paraguas\n- p → q: 'Si está lloviendo, entonces tengo paraguas' → Falso solo si llueve pero no tengo paraguas";
                    } else if (currentChapter === 2) {
                        question = "Ejemplo de circuito lógico";
                        answer = "Para la expresión (p ∧ q) ∨ r:\n1. Necesitas una compuerta AND para p ∧ q\n2. Esta salida se conecta a una compuerta OR junto con r\n3. El resultado final es 1 cuando: (p y q son 1) O (r es 1)\nEste circuito podría representar un sistema de alarma que se activa cuando (hay humo Y hay calor) O cuando alguien presiona manualmente el botón de emergencia.";
                    } else {
                        question = "Ejemplo de demostración";
                        answer = "Teorema: La suma de dos números pares es par.\nDemostración directa:\n1. Sean a y b números pares, entonces a = 2m, b = 2n para algunos enteros m, n\n2. a + b = 2m + 2n = 2(m + n)\n3. Como m + n es entero, a + b es múltiplo de 2, es decir, par.\nQED";
                    }
                    break;
                case 'ejercicio relacionado':
                    if (currentChapter === 1) {
                        question = "Ejercicio de lógica proposicional";
                        answer = "Ejercicio: Si p es verdadera, q es falsa y r es verdadera, determina el valor de:\n(¬p ∨ q) → (q ∧ r)\n\nSugerencia: Primero encuentra los valores de ¬p, ¬p ∨ q, y q ∧ r. Luego aplica la tabla de verdad del condicional.";
                    } else if (currentChapter === 2) {
                        question = "Ejercicio de circuitos lógicos";
                        answer = "Ejercicio: Diseña un circuito lógico para la expresión ¬(p ∨ q) ∧ r\n\nSugerencia: Necesitarás una compuerta OR para p ∨ q, una NOT para negar ese resultado, y una AND para combinar con r.";
                    } else {
                        question = "Ejercicio de demostración";
                        answer = "Ejercicio: Demuestra por contradicción que no existe el mayor número primo.\n\nSugerencia: Supón que existe un número primo mayor que todos. Considera el producto de todos los primos más 1. ¿Qué propiedades tiene este número?";
                    }
                    break;
                case 'aplicación práctica':
                    if (currentChapter === 1) {
                        question = "Aplicación de lógica proposicional";
                        answer = "La lógica proposicional se usa en:\n- Programación: Condiciones en sentencias if, bucles\n- Bases de datos: Consultas con operadores AND, OR, NOT\n- Derecho: Análisis de contratos y regulaciones\n- Electrónica: Diseño de circuitos digitales\n- Inteligencia artificial: Sistemas expertos y razonamiento automatizado";
                    } else if (currentChapter === 2) {
                        question = "Aplicación de circuitos lógicos";
                        answer = "Los circuitos lógicos son la base de:\n- Procesadores de computadoras: CPUs están compuestas de millones de compuertas\n- Memorias: Celdas de memoria usan circuitos flip-flop\n- Sistemas de control: Desde semáforos hasta naves espaciales\n- Dispositivos cotidianos: Calculadoras, relojes digitales, controles remotos";
                    } else {
                        question = "Aplicación de métodos de demostración";
                        answer = "Las técnicas de demostración son esenciales en:\n- Matemáticas puras: Para establecer verdades con certeza absoluta\n- Ciencias de la computación: Verificación formal de algoritmos\n- Ingeniería: Demostrar que un diseño cumple especificaciones\n- Criptografía: Probar la seguridad de protocolos\n- Filosofía: Análisis de argumentos y falacias";
                    }
                    break;
            }
            
            document.getElementById('iaExplanation').textContent = answer;
        }

        // Función para mostrar notificación de aprendizaje
        function showLearningNotice(message) {
            const notice = document.getElementById('learningNotice');
            notice.textContent = message;
            notice.classList.add('show');
            
            setTimeout(() => {
                notice.classList.remove('show');
            }, 3000);
        }

        // Función para actualizar la barra de progreso
        function updateProgressBar() {
            const knowledge = aiLearningSystem.userKnowledge;
            let totalScore = 0;
            let totalTopics = 0;
            
            for (const topic in knowledge) {
                if (knowledge[topic].attempts > 0) {
                    totalScore += knowledge[topic].score;
                    totalTopics++;
                }
            }
            
            const overallProgress = totalTopics > 0 ? (totalScore / totalTopics) * 100 : 0;
            
            document.getElementById('progressValue').style.width = `${overallProgress}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(overallProgress)}%`;
        }

        // Función para cambiar el tipo de ejercicio
        function changeExerciseType(type) {
            currentExerciseType = type;
            currentExerciseIndex = 0;
            
            // Actualizar botones activos
            document.querySelectorAll('.exercise-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mostrar/ocultar áreas según el tipo
            if (type === 'formula') {
                document.getElementById('formula-input-container').style.display = 'block';
                document.querySelector('.input-area').style.display = 'none';
                document.querySelector('.exercise').style.display = 'none';
            } else {
                document.getElementById('formula-input-container').style.display = 'none';
                document.querySelector('.input-area').style.display = 'flex';
                document.querySelector('.exercise').style.display = 'block';
                
                // Cargar nuevo ejercicio
                loadExercise();
            }
            
            addMessage(`He cambiado a ejercicios de ${getExerciseTypeName(type)}. ¿Necesitas ayuda con este tipo de problemas?`, "ai");
        }
        
        function getExerciseTypeName(type) {
            const names = {
                'basic': 'lógica básica',
                'truth-table': 'tablas de verdad',
                'circuit': 'circuitos lógicos',
                'formula': 'resolución de fórmulas'
            };
            return names[type] || type;
        }
        
        // Función para cargar el ejercicio actual
        function loadExercise() {
            if (currentExerciseType === 'formula') {
                return; // No cargar ejercicio predefinido para el tipo fórmula
            }
            
            const exercise = exercises[currentExerciseType][currentExerciseIndex];
            document.querySelector('.exercise-content').textContent = exercise.content;
            document.querySelector('.exercise-difficulty').textContent = `(${getExerciseTypeName(currentExerciseType)})`;
            
            // Limpiar feedback
            document.getElementById('feedbackSection').innerHTML = `
                <h3><i class="fas fa-comment-dots"></i> Retroalimentación</h3>
                <p>Aquí verás el análisis de tu respuesta y correcciones si es necesario.</p>
            `;
            
            // Limpiar área de texto
            document.getElementById('userSolution').value = '';
        }

        // Función mejorada para verificar la solución con IA avanzada
        function checkSolution() {
            const userSolution = document.getElementById('userSolution').value;
            const feedbackSection = document.getElementById('feedbackSection');
            
            if (!userSolution.trim()) {
                feedbackSection.innerHTML = `
                    <h3><i class="fas fa-exclamation-triangle"></i> Retroalimentación</h3>
                    <p>Por favor, escribe tu solución antes de verificar.</p>
                `;
                return;
            }
            
            // Mostrar indicador de typing
            showTypingIndicator();
            
            // Simular procesamiento con IA
            setTimeout(() => {
                // Análisis avanzado de la respuesta (simulación de IA mejorada)
                const exercise = exercises[currentExerciseType][currentExerciseIndex];
                let feedbackHTML = `
                    <h3><i class="fas fa-comment-dots"></i> Análisis Detallado de tu Respuesta</h3>
                `;
                
                // Análisis basado en el tipo de ejercicio
                if (currentExerciseType === 'basic') {
                    feedbackHTML += analyzeBasicSolution(userSolution, exercise);
                    // Actualizar conocimiento del usuario
                    aiLearningSystem.updateUserKnowledge('basic', true);
                } else if (currentExerciseType === 'truth-table') {
                    feedbackHTML += analyzeTruthTableSolution(userSolution, exercise);
                    aiLearningSystem.updateUserKnowledge('truthTable', true);
                } else if (currentExerciseType === 'circuit') {
                    feedbackHTML += analyzeCircuitSolution(userSolution, exercise);
                    aiLearningSystem.updateUserKnowledge('circuit', true);
                }
                
                feedbackSection.innerHTML = feedbackHTML;
                
                // Añadir mensaje del asistente
                addMessage("He analizado tu solución en detalle. ¿Hay algún concepto específico que te gustaría que explique más a fondo?", "ai");
                
                // Aprender de la conversación
                aiLearningSystem.learnFromConversation();
            }, 2000);
        }

        // Función para analizar soluciones de lógica básica
        function analyzeBasicSolution(userSolution, exercise) {
            let analysis = '';
            const lowerSolution = userSolution.toLowerCase();
            
            // Detectar valores de verdad correctos
            if (lowerSolution.includes("verdadero") || lowerSolution.includes("1") || lowerSolution.includes("true")) {
                analysis += `<p><i class="fas fa-check-circle" style="color: var(--success);"></i> Correcto: Has identificado valores verdaderos adecuadamente.</p>`;
            }
            
            if (lowerSolution.includes("falso") || lowerSolution.includes("0") || lowerSolution.includes("false")) {
                analysis += `<p><i class="fas fa-check-circle" style="color: var(--success);"></i> Correcto: Has identificado valores falsos adecuadamente.</p>`;
            }
            
            // Detectar operadores lógicos
            if (lowerSolution.includes("∧") || lowerSolution.includes("y") || lowerSolution.includes("conjunción")) {
                analysis += `<p><i class="fas fa-check-circle" style="color: var(--success);"></i> Correcto: Has reconocido la conjunción (∧).</p>`;
            }
            
            if (lowerSolution.includes("∨") || lowerSolution.includes("o") || lowerSolution.includes("disyunción")) {
                analysis += `<p><i class="fas fa-check-circle" style="color: var(--success);"></i> Correcto: Has reconocido la disyunción (∨).</p>`;
            }
            
            if (lowerSolution.includes("→") || lowerSolution.includes("entonces") || lowerSolution.includes("condicional")) {
                analysis += `<p><i class="fas fa-check-circle" style="color: var(--success);"></i> Correcto: Has reconocido el condicional (→).</p>`;
            }
            
            // Detectar posibles errores
            if (!lowerSolution.includes("falso") && !lowerSolution.includes("0") && !lowerSolution.includes("false")) {
                analysis += `<p><i class="fas fa-exclamation-circle" style="color: var(--accent);"></i> Revisar: No parece que hayas identificado valores falsos. Recuerda que p ∧ q es falso cuando al menos una proposición es falsa.</p>`;
            }
            
            if ((lowerSolution.includes("verdadero") || lowerSolution.includes("1")) && 
                !lowerSolution.includes("falso") && !lowerSolution.includes("0")) {
                analysis += `<p><i class="fas fa-exclamation-circle" style="color: var(--accent);"></i> Revisar: Parece que solo has identificado valores verdaderos. Recuerda que en lógica proposicional hay dos valores posibles: verdadero y falso.</p>`;
            }
            
            analysis += `
                <p><i class="fas fa-lightbulb" style="color: var(--warning);"></i> Sugerencia: Siempre verifica ambos valores de verdad (verdadero y falso) para cada operación lógica.</p>
                <p><i class="fas fa-star" style="color: var(--info);"></i> Mi análisis detectó que comprendes los conceptos básicos, pero debes prestar atención a los casos donde las proposiciones son falsas.</p>
            `;
            
            return analysis;
        }

        // Función para analizar soluciones de tablas de verdad
        function analyzeTruthTableSolution(userSolution, exercise) {
            let analysis = `
                <p><i class="fas fa-check-circle" style="color: var(--success);"></i> He detectado que estás trabajando con tablas de verdad.</p>
            `;
            
            if (userSolution.includes("combinación") || userSolution.includes("combinaciones")) {
                analysis += `<p><i class="fas fa-check-circle" style="color: var(--success);"></i> Correcto: Has considerado las combinaciones de valores de verdad.</p>`;
            } else {
                analysis += `<p><i class="fas fa-exclamation-circle" style="color: var(--accent);"></i> Revisar: Para tablas de verdad, es importante considerar todas las combinaciones posibles de valores de verdad.</p>`;
            }
            
            if (userSolution.includes("variable") || userSolution.includes("variables")) {
                analysis += `<p><i class="fas fa-check-circle" style="color: var(--success);"></i> Correcto: Has identificado las variables proposicionales.</p>`;
            }
            
            analysis += `
                <p><i class="fas fa-lightbulb" style="color: var(--warning);"></i> Sugerencia: Para n variables, una tabla de verdad tiene 2^n filas. Asegúrate de incluir todas las combinaciones posibles.</p>
                <p><i class="fas fa-star" style="color: var(--info);"></i> Mi análisis sugiere que comprendes la estructura de las tablas de verdad, pero debes verificar que hayas incluido todas las combinaciones posibles.</p>
            `;
            
            return analysis;
        }

        // Función para analizar soluciones de circuitos lógicos
        function analyzeCircuitSolution(userSolution, exercise) {
            let analysis = `
                <p><i class="fas fa-check-circle" style="color: var(--success);"></i> He detectado que estás trabajando con circuitos lógicos.</p>
            `;
            
            if (userSolution.includes("compuerta") || userSolution.includes("compuertas")) {
                analysis += `<p><i class="fas fa-check-circle" style="color: var(--success);"></i> Correcto: Has identificado las compuertas lógicas.</p>`;
            } else {
                analysis += `<p><i class="fas fa-exclamation-circle" style="color: var(--accent);"></i> Revisar: Para circuitos lógicos, es importante identificar las compuertas (AND, OR, NOT) correspondientes.</p>`;
            }
            
            if (userSolution.includes("AND") || userSolution.includes("OR") || userSolution.includes("NOT")) {
                analysis += `<p><i class="fas fa-check-circle" style="color: var(--success);"></i> Correcto: Has reconocido los tipos de compuertas lógicas.</p>`;
            }
            
            analysis += `
                <p><i class="fas fa-lightbulb" style="color: var(--warning);"></i> Sugerencia: Recuerda que AND representa la conjunción (∧), OR la disyunción (∨) y NOT la negación (¬).</p>
                <p><i class="fas fa-star" style="color: var(--info);"></i> Mi análisis indica que comprendes la relación entre operadores lógicos y compuertas, pero asegúrate de verificar todas las conexiones en tu circuito.</p>
            `;
            
            return analysis;
        }

        // Función para mostrar la solución completa
        function showSolution() {
            const exercise = exercises[currentExerciseType][currentExerciseIndex];
            addMessage("Claro, aquí está la solución paso a paso para el ejercicio actual:", "ai");
            
            // Mostrar indicador de typing
            showTypingIndicator();
            
            // Mostrar pasos de solución después de un breve delay
            setTimeout(() => {
                exercise.solution.steps.forEach((step, index) => {
                    setTimeout(() => {
                        addMessage(step, "ai");
                        
                        // Preguntar si necesita ayuda después del último paso
                        if (index === exercise.solution.steps.length - 1) {
                            setTimeout(() => {
                                addMessage("¿Te quedó claro? ¿Necesitas que explique algún paso en detalle?", "ai");
                            }, 500);
                        }
                    }, (index + 1) * 800);
                });
            }, 1000);
        }

        // Función para generar un nuevo ejercicio
        function newExercise() {
            // Avanzar al siguiente ejercicio (circular)
            currentExerciseIndex = (currentExerciseIndex + 1) % exercises[currentExerciseType].length;
            loadExercise();
            
            addMessage(`He generado un nuevo ejercicio de ${getExerciseTypeName(currentExerciseType)}. ¿Necesitas ayuda para resolverlo?`, "ai");
        }

        // Función para proporcionar una explicación adaptativa
        function adaptiveExplanation() {
            const exercise = exercises[currentExerciseType][currentExerciseIndex];
            let explanation = "";
            
            // Obtener explicación base según el tipo de ejercicio
            if (currentExerciseType === 'basic') {
                explanation = "Para resolver este ejercicio de lógica básica, debes seguir estos pasos:";
            } else if (currentExerciseType === 'truth-table') {
                explanation = "Para construir una tabla de verdad, sigue estos pasos:";
            } else if (currentExerciseType === 'circuit') {
                explanation = "Para diseñar un circuito lógico, considera estos pasos:";
            }
            
            // Obtener explicación adaptada
            explanation = aiLearningSystem.getAdaptedExplanation(currentExerciseType, explanation);
            
            // Añadir los pasos de la solución
            explanation += "\n\n" + exercise.solution.steps.join('\n');
            
            addMessage(explanation, "ai");
        }

        // Función para limpiar todo
        function clearAll() {
            document.getElementById('userSolution').value = '';
            document.getElementById('feedbackSection').innerHTML = `
                <h3><i class="fas fa-comment-dots"></i> Retroalimentación</h3>
                <p>Aquí verás el análisis de tu respuesta y correcciones si es necesario.</p>
            `;
            
            addMessage("He limpiado tu área de trabajo. ¿En qué puedo ayudarte ahora?", "ai");
        }

        // Función para mostrar indicador de typing
        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('typing-indicator');
            typingIndicator.id = 'typingIndicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.classList.add('typing-dot');
                typingIndicator.appendChild(dot);
            }
            
            chatContainer.appendChild(typingIndicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Función para ocultar indicador de typing
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Función para manejar la subida de imágenes
        function handleImageUpload(files) {
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                
                // Mostrar vista previa de la imagen
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // Mostrar barra de progreso
                    const progressBar = document.getElementById('progressBar');
                    const progressFill = document.getElementById('progressFill');
                    progressBar.style.display = 'block';
                    
                    // Simular análisis progresivo
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 5;
                        progressFill.style.width = `${progress}%`;
                        
                        if (progress >= 100) {
                            clearInterval(interval);
                            simulateImageAnalysis(file);
                        }
                    }, 100);
                };
                
                reader.readAsDataURL(file);
            }
        }

        // Función para simular el análisis de imagen
        function simulateImageAnalysis(file) {
            addMessage("He recibido tu imagen. Estoy analizando el problema...", "ai");
            
            // Ocultar barra de progreso
            setTimeout(() => {
                document.getElementById('progressBar').style.display = 'none';
                
                // Simular diferentes tipos de análisis basados en el nombre del archivo
                const fileName = file.name.toLowerCase();
                
                if (fileName.includes("tabla") || fileName.includes("verdad")) {
                    addMessage("He detectado una tabla de verdad en tu imagen. Déjame analizarla...", "ai");
                    setTimeout(() => {
                        addMessage("La tabla de verdad corresponde a la expresión: (p ∨ q) ∧ ¬p", "ai");
                        addMessage("¿Te gustaría que te muestre cómo construir esta tabla paso a paso?", "ai");
                        
                        // Cambiar a ejercicios de tabla de verdad
                        changeExerciseType('truth-table');
                    }, 2000);
                } else if (fileName.includes("circuito") || fileName.includes("compuerta")) {
                    addMessage("Veo que has subido un diagrama de circuito lógico. Analizando...", "ai");
                    setTimeout(() => {
                        addMessage("El circuito corresponde a la expresión: (p ∧ q) ∨ (¬p ∧ r)", "ai");
                        addMessage("¿Quieres que te explique cómo funciona este circuito?", "ai");
                        
                        // Cambiar a ejercicios de circuitos
                        changeExerciseType('circuit');
                    }, 2000);
                } else {
                    addMessage("He detectado un ejercicio de lógica proposicional en tu imagen.", "ai");
                    setTimeout(() => {
                        addMessage("Parece ser un problema que involucra valores de verdad y operaciones lógicas.", "ai");
                        addMessage("¿Te gustaría que te guíe en la solución?", "ai");
                        
                        // Cambiar a ejercicios básicos
                        changeExerciseType('basic');
                    }, 2000);
                }
            }, 1500);
        }

        // Función para enviar mensaje al asistente
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (message) {
                addMessage(message, "user");
                userInput.value = '';
                
                // Mostrar indicador de typing
                showTypingIndicator();
                
                // Simular思考过程
                setTimeout(() => {
                    hideTypingIndicator();
                    
                    // Buscar respuesta predefinida o usar default
                    const lowerMessage = message.toLowerCase();
                    let response = aiResponses.default;
                    
                    for (const [key, value] of Object.entries(aiResponses)) {
                        if (lowerMessage.includes(key)) {
                            response = value;
                            break;
                        }
                    }
                    
                    // Adaptar la respuesta según el sistema de aprendizaje
                    response = aiLearningSystem.getAdaptedExplanation(currentExerciseType, response);
                    
                    addMessage(response, "ai");
                    
                    // Aprender de la conversación
                    aiLearningSystem.learnFromConversation();
                }, 1500);
            }
        }
        
        // Función para enviar una sugerencia predefinida
        function sendSuggestion(suggestion) {
            document.getElementById('userInput').value = suggestion;
            sendMessage();
        }
        
        // Función para manejar la tecla Enter en el chat
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Función para añadir mensaje al chat con sistema de retroalimentación
        function addMessage(text, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(sender === 'ai' ? 'ai-message' : 'user-message');
            
            // Añadir ID único al mensaje para retroalimentación
            const messageId = `msg-${messageCounter++}`;
            messageElement.id = messageId;
            
            messageElement.textContent = text;
            
            // Añadir botones de retroalimentación para mensajes de IA
            if (sender === 'ai') {
                const feedbackButtons = document.createElement('div');
                feedbackButtons.classList.add('feedback-buttons');
                
                const helpfulBtn = document.createElement('button');
                helpfulBtn.classList.add('feedback-btn', 'helpful');
                helpfulBtn.innerHTML = '<i class="fas fa-thumbs-up"></i> Útil';
                helpfulBtn.onclick = function() {
                    aiLearningSystem.learnFromFeedback(messageId, true);
                    this.disabled = true;
                    notHelpfulBtn.disabled = true;
                };
                
                const notHelpfulBtn = document.createElement('button');
                notHelpfulBtn.classList.add('feedback-btn', 'not-helpful');
                notHelpfulBtn.innerHTML = '<i class="fas fa-thumbs-down"></i> No útil';
                notHelpfulBtn.onclick = function() {
                    const feedbackText = prompt("¿Cómo podría mejorar mi explicación?");
                    aiLearningSystem.learnFromFeedback(messageId, false, feedbackText);
                    this.disabled = true;
                    helpfulBtn.disabled = true;
                };
                
                feedbackButtons.appendChild(helpfulBtn);
                feedbackButtons.appendChild(notHelpfulBtn);
                
                messageElement.appendChild(feedbackButtons);
            }
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Guardar en historial de conversación
            aiLearningSystem.conversationHistory.push({
                id: messageId,
                text: text,
                sender: sender,
                timestamp: new Date()
            });
        }

        // NUEVAS FUNCIONES PARA EL ANALIZADOR DE FÓRMULAS
        
        // Función para insertar símbolos en el input de fórmula
        function insertSymbol(symbol) {
            const formulaInput = document.getElementById('formulaInput');
            const startPos = formulaInput.selectionStart;
            const endPos = formulaInput.selectionEnd;
            
            formulaInput.value = formulaInput.value.substring(0, startPos) + 
                                symbol + 
                                formulaInput.value.substring(endPos);
            
            // Colocar el cursor después del símbolo insertado
            formulaInput.selectionStart = formulaInput.selectionEnd = startPos + symbol.length;
            formulaInput.focus();
        }
        
        // Función para establecer un ejemplo de fórmula
        function setFormulaExample(formula) {
            document.getElementById('formulaInput').value = formula;
            document.getElementById('formulaInput').focus();
        }
        
        // Función para analizar la fórmula ingresada
        function analyzeFormula() {
            const formula = document.getElementById('formulaInput').value.trim();
            
            if (!formula) {
                alert('Por favor, ingresa una fórmula lógica');
                return;
            }
            
            // Mostrar indicador de typing
            showTypingIndicator();
            
            // Simular procesamiento
            setTimeout(() => {
                hideTypingIndicator();
                
                // Analizar la fórmula
                const result = parseFormula(formula);
                
                // Mostrar resultados
                displayFormulaResult(result, formula);
                
                // Añadir mensaje al chat
                addMessage(`He analizado la fórmula: ${formula}. ¿Necesitas que explique algún paso en detalle?`, "ai");
                
                // Actualizar conocimiento del usuario
                aiLearningSystem.updateUserKnowledge('formula', true);
            }, 1500);
        }
        
        // Función para parsear y analizar la fórmula
        function parseFormula(formula) {
            // Limpiar y normalizar la fórmula
            const cleanFormula = formula.replace(/\s+/g, '');
            
            // Validar caracteres permitidos
            if (!/^[a-zA-Z¬∧∨→↔()]+$/.test(cleanFormula)) {
                return {
                    valid: false,
                    error: "La fórmula contiene caracteres no válidos. Solo se permiten letras (variables) y los operadores lógicos: ¬, ∧, ∨, →, ↔"
                };
            }
            
            // Validar paréntesis balanceados
            if (!areParenthesesBalanced(cleanFormula)) {
                return {
                    valid: false,
                    error: "Los paréntesis no están balanceados correctamente"
                };
            }
            
            // Extraer variables
            const variables = extractVariables(cleanFormula);
            
            // Generar tabla de verdad
            const truthTable = generateTruthTable(cleanFormula, variables);
            
            // Simplificar la expresión (si es posible)
            const simplified = simplifyExpression(cleanFormula);
            
            // Determinar si es tautología, contradicción o contingencia
            const expressionType = determineExpressionType(truthTable);
            
            return {
                valid: true,
                formula: cleanFormula,
                variables: variables,
                truthTable: truthTable,
                simplified: simplified,
                type: expressionType,
                steps: generateSolutionSteps(cleanFormula, variables)
            };
        }
        
        // Función para verificar paréntesis balanceados
        function areParenthesesBalanced(formula) {
            let balance = 0;
            
            for (let char of formula) {
                if (char === '(') balance++;
                if (char === ')') balance--;
                
                if (balance < 0) return false;
            }
            
            return balance === 0;
        }
        
        // Función para extraer variables de la fórmula
        function extractVariables(formula) {
            const variables = new Set();
            
            for (let char of formula) {
                if (/[a-zA-Z]/.test(char)) {
                    variables.add(char);
                }
            }
            
            return Array.from(variables).sort();
        }
        
        // Función para generar la tabla de verdad
        function generateTruthTable(formula, variables) {
            const rows = Math.pow(2, variables.length);
            const table = [];
            
            // Generar todas las combinaciones de valores de verdad
            for (let i = 0; i < rows; i++) {
                const row = {};
                
                // Asignar valores a las variables
                for (let j = 0; j < variables.length; j++) {
                    const variable = variables[j];
                    // Usar bits para representar valores de verdad
                    row[variable] = Boolean((i >> (variables.length - 1 - j)) & 1);
                }
                
                // Evaluar la fórmula con estos valores
                row.result = evaluateFormula(formula, row);
                table.push(row);
            }
            
            return table;
        }
        
        // Función para evaluar una fórmula con valores dados
        function evaluateFormula(formula, values) {
            // Convertir la fórmula a notación que JavaScript pueda evaluar
            let jsFormula = formula
                .replace(/¬/g, '!')
                .replace(/∧/g, '&&')
                .replace(/∨/g, '||')
                .replace(/→/g, '=>')
                .replace(/↔/g, '==');
            
            // Reemplazar variables con sus valores
            for (let variable in values) {
                const regex = new RegExp(variable, 'g');
                jsFormula = jsFormula.replace(regex, values[variable]);
            }
            
            // Reemplazar el operador => (implicación) con su equivalente lógico
            jsFormula = jsFormula.replace(/=>/g, '? !');
            
            // Evaluar la expresión
            try {
                // Para manejar la implicación (p → q equivale a ¬p ∨ q)
                if (jsFormula.includes('?')) {
                    const parts = jsFormula.split('?');
                    if (parts.length === 2) {
                        const [left, right] = parts;
                        return !eval(left) || eval(right);
                    }
                }
                
                return eval(jsFormula);
            } catch (e) {
                console.error("Error evaluando fórmula:", e);
                return null;
            }
        }
        
        // Función para simplificar una expresión (versión básica)
        function simplifyExpression(formula) {
            // Esta es una simplificación básica, se puede mejorar
            let simplified = formula
                .replace(/¬¬/g, '') // Doble negación
                .replace(/\(([a-zA-Z])\)/g, '$1'); // Paréntesis innecesarios alrededor de variables
            
            // Intenta algunas simplificaciones comunes
            if (formula === '(p∧q)∨(p∧¬q)') return 'p';
            if (formula === '(p∨q)∧(p∨¬q)') return 'p';
            if (formula === 'p∨¬p') return '1'; // Tautología
            if (formula === 'p∧¬p') return '0'; // Contradicción
            
            return simplified;
        }
        
        // Función para determinar el tipo de expresión
        function determineExpressionType(truthTable) {
            const allTrue = truthTable.every(row => row.result);
            const allFalse = truthTable.every(row => !row.result);
            
            if (allTrue) return 'tautología';
            if (allFalse) return 'contradicción';
            return 'contingencia';
        }
        
        // Función para generar pasos de solución
        function generateSolutionSteps(formula, variables) {
            const steps = [];
            
            steps.push(`1. Identificamos las variables: ${variables.join(', ')}`);
            steps.push(`2. La fórmula a evaluar es: ${formula}`);
            steps.push(`3. Construimos la tabla de verdad con ${Math.pow(2, variables.length)} filas`);
            steps.push("4. Evaluamos la fórmula para cada combinación de valores");
            
            // Añadir más pasos según la complejidad de la fórmula
            if (formula.includes('→')) {
                steps.push("5. Recordemos que p → q es equivalente a ¬p ∨ q");
            }
            
            if (formula.includes('↔')) {
                steps.push("5. Recordemos que p ↔ q es equivalente a (p → q) ∧ (q → p)");
            }
            
            return steps;
        }
        
        // Función para mostrar los resultados del análisis
        function displayFormulaResult(result, originalFormula) {
            const resultContainer = document.getElementById('formulaResult');
            
            if (!result.valid) {
                resultContainer.innerHTML = `
                    <div style="color: var(--accent);">
                        <h4><i class="fas fa-exclamation-circle"></i> Error en la fórmula</h4>
                        <p>${result.error}</p>
                    </div>
                `;
                resultContainer.style.display = 'block';
                return;
            }
            
            let html = `
                <h4><i class="fas fa-check-circle" style="color: var(--success);"></i> Análisis de: ${originalFormula}</h4>
                <p><strong>Variables identificadas:</strong> ${result.variables.join(', ')}</p>
                <p><strong>Tipo de expresión:</strong> ${result.type}</p>
            `;
            
            if (result.simplified && result.simplified !== result.formula) {
                html += `
                    <div class="simplified-formula">
                        <strong>Fórmula simplificada:</strong> ${result.simplified}
                    </div>
                `;
            }
            
            html += `
                <h5>Tabla de Verdad:</h5>
                <table class="evaluation-table">
                    <tr>
                        ${result.variables.map(v => `<th>${v}</th>`).join('')}
                        <th>Resultado</th>
                    </tr>
            `;
            
            result.truthTable.forEach(row => {
                html += `
                    <tr>
                        ${result.variables.map(v => `<td>${row[v] ? 'V' : 'F'}</td>`).join('')}
                        <td><strong>${row.result ? 'V' : 'F'}</strong></td>
                    </tr>
                `;
            });
            
            html += `
                </table>
                <div class="evaluation-steps">
                    <h5>Pasos de la solución:</h5>
                    ${result.steps.map(step => `<div class="step">${step}</div>`).join('')}
                </div>
            `;
            
            resultContainer.innerHTML = html;
            resultContainer.style.display = 'block';
        }

        // Configurar arrastrar y soltar
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageUpload(files);
            }
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos de aprendizaje previos
            aiLearningSystem.loadFromLocalStorage();
            
            // Configurar el primer ejercicio
            loadExercise();
            
            // Añadir mensaje de bienvenida del asistente
            setTimeout(() => {
                addMessage("Ahora puedo analizar fórmulas lógicas que me escribas. Usa el botón 'Resolver Fórmula' para probarlo.", "ai");
            }, 1000);
        });
    </script>
</body>
</html>